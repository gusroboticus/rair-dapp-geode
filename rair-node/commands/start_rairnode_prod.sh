#!/bin/bash

echo "Starting Rairnode with PROD boot script 11111"

GCP_PROJECT_ID=$(gcloud config get-value project)

# Manually set this to match the resource names that are generated by Terraform
VAULT_ROLE_ID_RESOURCE_NAME="gke-vault-role-id-rairnode"
VAULT_SECRET_ID_RESOURCE_NAME="gke-vault-secret-id-rairnode"
JWT_SECRET_NAME="JWT_SECRET"
MONGO_URI_NAME="MONGO_URI"
PINATA_SECRET_NAME="PINATA_SECRET"
RAIR_FILE_MANAGER_NAME="RAIR_FILE_MANAGER"

SERVICE_ACCOUNT="gke-rairnode@rair-market-dev.iam.gserviceaccount.com"

MORALIS_MASTER_KEY_MAIN_NAME="MORALIS_MASTER_KEY_MAIN"

echo "auth list"
gcloud auth list

echo "Getting secret: $VAULT_ROLE_ID_RESOURCE_NAME..."
export VAULT_RAIRNODE_APP_ROLE_ID=$(gcloud secrets versions access latest --project=$GCP_PROJECT_ID --secret="$VAULT_ROLE_ID_RESOURCE_NAME")

echo "Getting secret: $VAULT_SECRET_ID_RESOURCE_NAME..."
export VAULT_RAIRNODE_APP_ROLE_SECRET_ID=$(gcloud secrets versions access latest --project=$GCP_PROJECT_ID --secret="$VAULT_SECRET_ID_RESOURCE_NAME")

echo "Getting secret: JWT_SECRET..."
export JWT_SECRET=$(gcloud secrets versions access latest --project=$GCP_PROJECT_ID --secret="$JWT_SECRET_NAME")

echo "Getting secret MONGO URI..."
export MONGO_URI=$(gcloud secrets versions access latest --project=$GCP_PROJECT_ID --secret="$MONGO_URI_NAME")
echo "$MONGO_URI"

echo "Getting secret PINATA_SECRET"
export PINATA_SECRET=$(gcloud secrets versions access latest --project=$GCP_PROJECT_ID --secret="$PINATA_SECRET_NAME")

echo "Getting secret RAIR_FILE_MANAGER"
export RAIR_FILE_MANAGER=$(gcloud secrets versions access latest --project=$GCP_PROJECT_ID --secret="$RAIR_FILE_MANAGER_NAME")

echo "Getting MORALIS_MASTER_KEY_MAIN..."
export MORALIS_MASTER_KEY_MAIN=$(gcloud secrets versions access latest --project=$GCP_PROJECT_ID --secret="$MORALIS_MASTER_KEY_MAIN_NAME")

echo "Running npm start..."
# fire the container as normal

npm start